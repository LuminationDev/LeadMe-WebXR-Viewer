<!doctype html>
<html style="height: 100%; width: 100%; overflow: hidden; margin: -8px;">
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='icon' type='image/png' sizes='96x96' href='favicon-96x96.png'>
    <link rel='stylesheet' href='css/common.css'>

    <title>Inline Session</title>
  </head>
  <body style="height: 100%; width: 100%;">
    <div id="main-body" style="width: 100%; height: 100%; background: rgb(224,221,13);background: radial-gradient(circle, rgba(224,221,13,1) 14%, rgba(219,88,21,1) 47%, rgba(206,0,255,1) 71%); display: flex; justify-content: center; align-items: center;">
        <img id="logo" class="w-32">
    </div>
    <script type="module">
      import {WebXRConnectionIndicator} from './js/util/webxr-connection-indicator.js';
      import {QueryArgs} from './js/util/query-args.js';

      // If requested, use the polyfill to provide support for mobile devices
      // and devices which only support WebVR.
      import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';
      if (QueryArgs.getBool('usePolyfill', true)) {
        let polyfill = new WebXRPolyfill();
      }

      // process command line args
      var app = null
      var code = null
      const args = nw.App.argv
      for (var i = 0; i < args.length; i++) {
          if (args[i] === "-app" && args.length >= i) {
              app = args[i + 1]
          }
          if (args[i] === "-code" && args.length >= i) {
              code = args[i + 1]
          }
      }

      const logo = document.getElementById("logo")
      // const myWebview = document.getElementById("my-webview")

      if (app === 'cospaces') {
          logo.src = "./media/logo/cospaces.png"
          // initialise cospaces
      } else if (app === 'thinglink') {
          logo.src = "./media/logo/thinglink.svg"
      } else {
          // show not supported messages
      }

      // XR globals.
      let xrButton = null;

      let gl = null;

      function initXR() {
        xrButton = new WebXRConnectionIndicator({
          onRequestSession: () => {},
          onEndSession: onEndSession
        });
        document.querySelector('#main-body').appendChild(xrButton.domElement);

        if (navigator.xr) {
          launchLegacyMirror()

          navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
            xrButton.enabled = supported;
            if (supported) {
                setTimeout(() => {
                    if (app && code) {
                        if (app === 'cospaces') {
                            window.open("https://edu.cospaces.io/" + code, "_self")
                        } else if (app === 'thinglink') {
                            window.open("https://www.thinglink.com/webvr/" + code, "_self")
                        }
                    } else {
                        // var w = window.open("https://edu.cospaces.io/WVM-FQJ", "_self")
                        // var w = window.open("https://www.thinglink.com/webvr/1438396250608107521", "_self")
                        // var w = window.open("https://immersive-web.github.io/webxr-samples/inline-session.html?usePolyfill=0", "_self")
                    }
                }, 2000)
            }
          });
        }
      }

      function launchLegacyMirror() {
          var alreadyOpen = false;
          var spawn = require("child_process").spawn,child;
          child = spawn("powershell.exe",["Get-Process | Where {$_.MainWindowTitle -eq \"Legacy Mirror\"}"]);
          child.stdout.on("data",function(data){
              if (data) {
                  alreadyOpen = true
                  return;
              }
              return;
          });
          child.stderr.on("data",function(data){
          });
          child.on("exit",function(){
              if (alreadyOpen) {
                  return;
              }
              var spawn2 = require("child_process").spawn,child2;
              child2 = spawn2("powershell.exe",["Start-Process \"vrmonitor://debugcommands/legacy_mirror_view_toggle\""]);
              child2.stdout.on("data",function(data){
              });
              child2.stderr.on("data",function(data){
              });
              child2.on("exit",function(){
              });
              child2.stdin.end(); //end input
          });
          child.stdin.end(); //end input
      }

      function onEndSession(session) {
        session.end();
      }

      // Start the XR application.
      initXR();
    </script>
  </body>
</html>
