<!doctype html>
<html style="height: 100%; width: 100%; overflow: hidden; margin: -8px;">
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <link rel='stylesheet' href='css/common.css'>
    <link rel='stylesheet' href='css/utilities.css'>

    <title>LeadMe WebXR Viewer</title>
  </head>
  <body style="height: 100%; width: 100%;">
    <div id="main-body" style="width: 100%; height: 100%; background: #102A56; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div class="flex flex-row justify-center items-center">
            <img class="h-16 w-auto" src="assets/leadme_logo.svg">
            <div style="color: white; font-size: 32px; margin-right: 12px; margin-left: 12px;">+</div>
            <img id="logo" class="h-16 w-auto">
        </div>
        <hr style="background: #194185; height: 2px; width: 280px; border: none; margin-top: 20px; margin-bottom: 20px;"/>
        <div>
            <span id="loading-text" style="color: white; font-size: 32px; font-weight: 400">Connecting to headset...</span>
        </div>
    </div>
    <script type="module">
      import {QueryArgs} from './js/util/query-args.js';

      // If requested, use the polyfill to provide support for mobile devices
      // and devices which only support WebVR.
      import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';
      if (QueryArgs.getBool('usePolyfill', true)) {
        let polyfill = new WebXRPolyfill();
      }

      // process command line args
      var app = null
      var code = null
      const args = nw.App.argv
      for (var i = 0; i < args.length; i++) {
          if (args[i] === "-app" && args.length >= i) {
              app = args[i + 1]
          }
          if (args[i] === "-code" && args.length >= i) {
              code = args[i + 1]
          }
      }

      const logo = document.getElementById("logo")

      if (app === 'cospaces') {
          logo.src = "assets/cospaces_logo.svg"
          // initialise cospaces
      } else if (app === 'thinglink') {
          logo.src = "./media/logo/thinglink.svg"
      } else {
          document.getElementById("loading-text").innerText = "Experience type is not supported."
      }

      var text = document.getElementById("loading-text")

      function updateLoadingText () {
          if (text.innerText.startsWith("Connecting to headset")) {
              if (text.innerText.endsWith("...")) {
                  text.innerText = "Connecting to headset"
              } else {
                  text.innerText += "."
              }
              setTimeout(updateLoadingText, 700)
          }
      }
      updateLoadingText()

      function initXR() {
        if (navigator.xr) {
          launchLegacyMirror()
          connectXR()
        } else {
            document.getElementById("loading-text").innerText = "XR is not supported"
        }
      }

      function connectXR() {
          navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
              if (supported) {
                  document.getElementById("loading-text").innerText = "Connected. Launching your experience!"
                  setTimeout(() => {
                      if (app && code) {
                          if (app === 'cospaces') {
                              window.open("https://edu.cospaces.io/" + code, "_self")
                          } else if (app === 'thinglink') {
                              window.open("https://www.thinglink.com/webvr/" + code, "_self")
                          }
                      } else {
                          document.getElementById("loading-text").innerText = "Launch code not provided"
                      }
                  }, 2000)
              } else {
                  setTimeout(connectXR, 2000)
              }
          });
      }

      function launchLegacyMirror() {
          var alreadyOpen = false;
          var spawn = require("child_process").spawn,child;
          child = spawn("powershell.exe",["Get-Process | Where {$_.MainWindowTitle -eq \"Legacy Mirror\"}"]);
          child.stdout.on("data",function(data){
              if (data) {
                  alreadyOpen = true
                  return;
              }
              return;
          });
          child.stderr.on("data",function(data){
          });
          child.on("exit",function(){
              if (alreadyOpen) {
                  return;
              }
              var spawn2 = require("child_process").spawn,child2;
              child2 = spawn2("powershell.exe",["Start-Process \"vrmonitor://debugcommands/legacy_mirror_view_toggle\""]);
              child2.stdout.on("data",function(data){
              });
              child2.stderr.on("data",function(data){
              });
              child2.on("exit",function(){
              });
              child2.stdin.end();
          });
          child.stdin.end();
      }

      initXR();
    </script>
  </body>
</html>